set(LUFA_DIR packages/lufa)

LIST(APPEND SRC_lufa ${LUFA_DIR}/LUFA/Drivers/USB/Core/AVR8/USBController_AVR8.c)
LIST(APPEND SRC_lufa ${LUFA_DIR}/LUFA/Drivers/USB/Core/AVR8/USBInterrupt_AVR8.c)
LIST(APPEND SRC_lufa ${LUFA_DIR}/LUFA/Drivers/USB/Core/ConfigDescriptors.c)
LIST(APPEND SRC_lufa ${LUFA_DIR}/LUFA/Drivers/USB/Core/Events.c)
LIST(APPEND SRC_lufa ${LUFA_DIR}/LUFA/Drivers/USB/Core/USBTask.c)
LIST(APPEND SRC_lufa ${LUFA_DIR}/LUFA/Drivers/USB/Core/AVR8/Device_AVR8.c)
LIST(APPEND SRC_lufa ${LUFA_DIR}/LUFA/Drivers/USB/Core/AVR8/Endpoint_AVR8.c)
LIST(APPEND SRC_lufa ${LUFA_DIR}/LUFA/Drivers/USB/Core/AVR8/EndpointStream_AVR8.c)
LIST(APPEND SRC_lufa ${LUFA_DIR}/LUFA/Drivers/USB/Core/DeviceStandardReq.c)
LIST(APPEND SRC_lufa src/descriptors-lufa.c)
set(INC_lufa ${LUFA_DIR})
set(CFLAGS_lufa -std=c99 -DARCH=ARCH_AVR8 -DUSE_LUFA_CONFIG_HEADER)

function(generate_config_lufa target)
  message(STATUS "Generating lufa config for ${target}")
  set(conf ${CMAKE_BINARY_DIR}/include-${target}/LUFAConfig.h)
  file(WRITE ${conf} "/* Autogenerated. Do not edit */\n")
  file(APPEND ${conf} "#ifndef _USB_UHID_CONFIG\n")
  file(APPEND ${conf} "#define _USB_UHID_CONFIG\n")

  defconf(DISABLE_TERMINAL_CODES)
  defconf(ORDERED_EP_CONFIG )
  defconf(USE_STATIC_OPTIONS "(USB_DEVICE_OPT_FULLSPEED | USB_OPT_REG_ENABLED)")
  defconf(USB_DEVICE_ONLY )
  defconf(NO_SOF_EVENTS )
  defconf(NO_STREAM_CALLBACKS)
  defconf(INTERRUPT_CONTROL_ENDPOINT)
  defconf(USE_FLASH_DESCRIPTORS)
  defconf(FIXED_CONTROL_ENDPOINT_SIZE      8)
  defconf(FIXED_NUM_CONFIGURATIONS         1)
  defconf(CONTROL_ONLY_DEVICE)
  defconf(NO_DEVICE_REMOTE_WAKEUP)

  defconf(USB_CFG_DEVICE_ID 0x${CONFIG_USB_PID})
  defconf(USB_CFG_VENDOR_ID 0x${CONFIG_USB_VID})
  defconf(USB_CFG_SERIAL_NUMBER L"${CONFIG_USB_SERIAL}")
  defconf(USB_CFG_VENDOR_NAME L"${CONFIG_USB_VENDOR}")
  defconf(USB_CFG_DEVICE_NAME L"${CONFIG_USB_PRODUCT}")


  generate_common_config()
  file(APPEND ${conf} "#endif\n")
endfunction()
